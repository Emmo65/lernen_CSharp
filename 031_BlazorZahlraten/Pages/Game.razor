@page "/game"
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using System.Linq
@inject IJSRuntime JS

<div class="game-page">
    <div class="game-card">
        <header class="game-header">
            <h1 class="game-title">Zahlraten</h1>
            <p class="game-subtitle">
                Wähle einen Schwierigkeitsgrad, starte das Spiel und versuche die geheime Zahl zu erraten.
            </p>
        </header>

        <section class="game-difficulty">
            <div class="difficulty-label">Schwierigkeit</div>

            <div class="difficulty-options">
                <label class="difficulty-pill @(IsDifficultyChecked(Difficulty.Easy) ? "active" : null)">
                    <input type="radio"
                           name="difficulty"
                           @onchange="() => SetDifficulty(Difficulty.Easy)" />
                    <span>Leicht · 1–50 · 10 Versuche</span>
                </label>

                <label class="difficulty-pill @(IsDifficultyChecked(Difficulty.Medium) ? "active" : null)">
                    <input type="radio"
                           name="difficulty"
                           @onchange="() => SetDifficulty(Difficulty.Medium)" />
                    <span>Mittel · 1–100 · 8 Versuche</span>
                </label>

                <label class="difficulty-pill @(IsDifficultyChecked(Difficulty.Hard) ? "active" : null)">
                    <input type="radio"
                           name="difficulty"
                           @onchange="() => SetDifficulty(Difficulty.Hard)" />
                    <span>Schwer · 1–200 · 6 Versuche</span>
                </label>
            </div>
        </section>

        <section class="game-controls">
            <div class="game-input">
                <label for="guessInput">Dein Tipp</label>
                <input id="guessInput"
                       type="number"
                       @bind="currentGuessText"
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown" />
            </div>

            <div class="game-buttons">
                <button class="btn btn-success" @onclick="MakeGuess" disabled="@isGameOver">
                    Tipp abgeben
                </button>

                <button class="btn btn-secondary" @onclick="StartNewGame">
                    Neu starten
                </button>
            </div>
        </section>

        <section class="game-status">
            <div class="game-cheat">
                <label>
                    <input type="checkbox" @bind="showSecret" />
                    Cheat: Geheime Zahl anzeigen
                </label>

                @if (showSecret)
                {
                    <span><strong>Geheime Zahl:</strong> @secretNumber</span>
                }
            </div>

            <p><strong>Hinweis:</strong> @message</p>
            <p><strong>Versuche:</strong> @attempts.Count / @maxAttempts</p>

            <div class="game-progress">
                <label>Fortschritt</label>
                <progress value="@attempts.Count" max="@maxAttempts"></progress>
            </div>
        </section>

        <section class="game-history">
            <h5>Versuchshistorie</h5>

            @if (guessHistory.Count == 0)
            {
                <p>Noch keine Versuche.</p>
            }
            else
            {
                <div class="history-toolbar">
                    <span class="history-label">Sortieren nach:</span>

                    <button type="button"
                            class="@SortClassNumber"
                            @onclick="SetSortByNumber">
                        Nr.
                    </button>

                    <button type="button"
                            class="@SortClassGuess"
                            @onclick="SetSortByGuess">
                        Tipp
                    </button>

                    <button type="button"
                            class="@SortClassResult"
                            @onclick="SetSortByResult">
                        Ergebnis
                    </button>

                    <button type="button"
                            class="history-sort-btn direction"
                            @onclick="ToggleSortDirection">
                        Richtung: @SortDirectionSymbol
                    </button>
                </div>

                <MudTable Items="SortedGuessHistory"
                          Hover="true"
                          Dense="true"
                          Elevation="10"
                          Class="guess-table neon-table">
                    <HeaderContent>
                        <MudTh>Nr.</MudTh>
                        <MudTh>Tipp</MudTh>
                        <MudTh>Ergebnis</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd DataLabel="Nr.">@context.Number</MudTd>
                        <MudTd DataLabel="Tipp">@context.Guess</MudTd>
                        <MudTd DataLabel="Ergebnis">
                            <span class="guess-pill @context.CssClass">
                                <span class="guess-pill-icon">@context.Trend</span>
                                <span>@context.Hint</span>
                            </span>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </section>
    </div>
</div>

@code
{
    enum Difficulty
    {
        Easy,
        Medium,
        Hard
    }

    private Difficulty selectedDifficulty = Difficulty.Easy;
    private int secretNumber;
    private int maxAttempts;
    private bool gameStarted = false;
    private bool isGameOver = false;
    private string? currentGuessText;
    private string message = "Noch kein Tipp abgegeben.";
    private bool showSecret = false;
    private readonly List<int> attempts = new();
    private readonly Random rng = new();

    private readonly List<GuessEntry> guessHistory = new();

    // Sortierung
    private string sortField = "Number"; // "Number", "Guess", "Result"
    private bool sortAscending = true;

    private IEnumerable<GuessEntry> SortedGuessHistory
    {
        get
        {
            IEnumerable<GuessEntry> query = guessHistory;

            return sortField switch
            {
                "Guess" => sortAscending
                    ? query.OrderBy(e => e.Guess)
                    : query.OrderByDescending(e => e.Guess),
                "Result" => sortAscending
                    ? query.OrderBy(e => e.Hint)
                    : query.OrderByDescending(e => e.Hint),
                _ => sortAscending
                    ? query.OrderBy(e => e.Number)
                    : query.OrderByDescending(e => e.Number)
            };
        }
    }

    private string SortClassNumber => sortField == "Number"
        ? "history-sort-btn active"
        : "history-sort-btn";

    private string SortClassGuess => sortField == "Guess"
        ? "history-sort-btn active"
        : "history-sort-btn";

    private string SortClassResult => sortField == "Result"
        ? "history-sort-btn active"
        : "history-sort-btn";

    private string SortDirectionSymbol => sortAscending ? "↑" : "↓";

    private class GuessEntry
    {
        public int Number { get; set; }
        public int Guess { get; set; }
        public string Hint { get; set; } = string.Empty;
        public string Trend { get; set; } = string.Empty;    // ⮙, ⮛, ★
        public string CssClass { get; set; } = string.Empty; // fürs Farb-CSS
    }

    protected override void OnInitialized()
    {
        SetDifficulty(Difficulty.Easy);
        StartNewGame();
    }

    private void SetDifficulty(Difficulty diff)
    {
        selectedDifficulty = diff;

        switch (diff)
        {
            case Difficulty.Easy:
                maxAttempts = 10;
                break;
            case Difficulty.Medium:
                maxAttempts = 8;
                break;
            case Difficulty.Hard:
                maxAttempts = 6;
                break;
        }
    }

    private bool IsDifficultyChecked(Difficulty diff)
        => selectedDifficulty == diff;

    private void StartNewGame()
    {
        int maxValue = selectedDifficulty switch
        {
            Difficulty.Easy => 50,
            Difficulty.Medium => 100,
            Difficulty.Hard => 200,
            _ => 100
        };

        secretNumber = rng.Next(1, maxValue + 1);
        attempts.Clear();
        guessHistory.Clear();
        isGameOver = false;
        gameStarted = true;
        showSecret = false;
        currentGuessText = string.Empty;
        message = $"Ich habe mir eine Zahl zwischen 1 und {maxValue} ausgedacht. Rate sie!";
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == "NumpadEnter")
        {
            MakeGuess();
        }
    }

    private void MakeGuess()
    {
        if (!gameStarted)
        {
            message = "Bitte starte zuerst ein neues Spiel.";
            return;
        }

        if (isGameOver)
        {
            message = "Das Spiel ist vorbei. Starte ein neues Spiel.";
            return;
        }

        if (string.IsNullOrWhiteSpace(currentGuessText) || !int.TryParse(currentGuessText, out int guess))
        {
            message = "Bitte gib eine gültige Zahl ein.";
            return;
        }

        attempts.Add(guess);

        string hint;
        string trend;
        string cssClass;

        if (guess == secretNumber)
        {
            hint = "Richtig!";
            message = $"Richtig! Die Zahl war {secretNumber}. Du hast {attempts.Count} Versuche gebraucht.";
            isGameOver = true;

            trend = "★";                    // Volltreffer
            cssClass = "guess-chip-correct";

            JS.InvokeVoidAsync("launchConfetti");
        }
        else if (attempts.Count >= maxAttempts)
        {
            if (guess < secretNumber)
            {
                hint = "Zu niedrig (Game Over)";
                trend = "⮙";                 // du hättest höher tippen müssen
                cssClass = "guess-chip-low";
            }
            else
            {
                hint = "Zu hoch (Game Over)";
                trend = "⮛";                 // du hättest niedriger tippen müssen
                cssClass = "guess-chip-high";
            }

            message = $"Keine Versuche mehr! Die Zahl war {secretNumber}.";
            isGameOver = true;
        }
        else if (guess < secretNumber)
        {
            hint = "Zu niedrig";
            message = "Zu niedrig! Versuch eine größere Zahl.";

            trend = "⮙";
            cssClass = "guess-chip-low";
        }
        else
        {
            hint = "Zu hoch";
            message = "Zu hoch! Versuch eine kleinere Zahl.";

            trend = "⮛";
            cssClass = "guess-chip-high";
        }

        guessHistory.Add(new GuessEntry
        {
            Number = guessHistory.Count + 1,
            Guess = guess,
            Hint = hint,
            Trend = trend,
            CssClass = cssClass
        });

        currentGuessText = string.Empty;
    }

    // Sortier-Methoden
    private void SetSortByNumber() => SetSort("Number");
    private void SetSortByGuess() => SetSort("Guess");
    private void SetSortByResult() => SetSort("Result");

    private void SetSort(string field)
    {
        if (sortField == field)
        {
            // erneut klicken -> Richtung umdrehen
            sortAscending = !sortAscending;
        }
        else
        {
            sortField = field;
            sortAscending = true;
        }
    }

    private void ToggleSortDirection()
    {
        sortAscending = !sortAscending;
    }
}
